<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><style>*{box-sizing:border-box}body{font-family:Arial,Helvetica,sans-serif}#chatlog{position:fixed;top:0;bottom:32px;left:0;right:200px;overflow-y:auto;padding:8px;overflow-wrap:break-word}#chatlog span.username{font-weight:bold}#spacer{height:calc(100vh - 32px - 5em)}#roster{font-weight:bold;padding:8px}p{margin-top:0;margin-bottom:8px}p:last-of-type{margin:0}#roster{position:fixed;right:0;top:0;bottom:32px;width:200px;border-left:none}::-webkit-scrollbar{display:none}@media(max-width:600px){#roster{display:none}#chatlog{right:0}}#chat-input{position:fixed;width:100%;height:32px;bottom:0;left:0;border:none;border-top:none;padding-left:32px;outline:none}#chatroom::before{z-index:1;display:block;content:">";position:fixed;bottom:0;left:0;width:32px;height:32px;line-height:32px;text-align:center;font-weight:bold;color:#888;-webkit-text-stroke-width:2px}#name-form{position:fixed;z-index:3;top:0;bottom:0;left:0;right:0;background-color:white}#name-input{position:fixed;font-size:200%;top:calc(50% - 1em);left:calc(50% - 8em);width:16em;height:2em;margin:0;text-align:center;border:1px solid #bbb}#name-form p{position:fixed;top:calc(50% + 3em);width:100%;text-align:center}#room-form{position:fixed;z-index:2;top:0;bottom:0;left:0;right:0;background-color:white;font-size:200%;margin-top:calc(50vh - 3em);text-align:center}#room-name{font-size:inherit;border:1px solid #bbb;height:2em;width:16em;padding-left:1em}#room-form button{font-size:inherit;border:1px solid #bbb;background-color:#eee;height:2em}@media(max-width:660px){#name-input,#room-form{font-size:150%}#name-form p{font-size:75%}}@media(max-width:500px){#name-input,#room-form{font-size:100%}#name-form p{font-size:50%}}#go-public{width:4em}#go-private{width:20em}</style></head><body><form id="name-form" action="/fake-form-action"><input id="name-input" placeholder="your name"><p>This chat runs entirely on the edge, powered by<br><a href="https://blog.cloudflare.com/introducing-workers-durable-objects" target="_blank">Cloudflare Workers Durable Objects</a></p></form><form id="room-form" action="/fake-form-action"><p>Enter a public room:</p><input id="room-name" placeholder="room name"><button id="go-public">Go &raquo;</button><p>OR</p><button id="go-private">Create a Private Room &raquo;</button></form><form id="chatroom" action="/fake-form-action"><div id="chatlog"><div id="spacer"></div></div><div id="roster"></div><input id="chat-input"></form><script>
let a=null,b=document.querySelector("#name-form"),c=document.querySelector("#name-input"),d=document.querySelector("#room-form"),e=document.querySelector("#room-name"),f=document.querySelector("#go-public"),g=document.querySelector("#go-private"),h=document.querySelector("#chatroom"),i=document.querySelector("#chatlog"),j=document.querySelector("#chat-input"),k=document.querySelector("#roster"),l=!0,m,n,o=window.location.host||"edge-chat-demo.cloudflareworkers.com";function p(){b.addEventListener("submit",e=>{e.preventDefault();m=c.value;m.length>0&&q()}),c.addEventListener("input",e=>{e.currentTarget.value=e.currentTarget.value.slice(0,32)}),c.focus()}function q(){b.remove(),document.location.hash.length>1?(n=document.location.hash.slice(1),r()):(d.addEventListener("submit",e=>{e.preventDefault();n=e.value;n.length>0&&r()}),e.addEventListener("input",e=>{e.currentTarget.value=e.currentTarget.value.slice(0,32)}),f.addEventListener("click",e=>{n=e.value;n.length>0&&r()}),g.addEventListener("click",async e=>{e.currentTarget.disabled=!0,e=f.disabled=!0,d.disabled=!0;let t=await fetch("https://"+o+"/api/room",{method:"POST"});if(!t.ok)return alert("something went wrong"),document.location.reload(),void 0;n=await t.text(),r()}),e.focus())}function r(){d.remove(),n=n.replace(/[^a-zA-Z0-9_-]/g,"").replace(/_/g,"-").toLowerCase(),n.length>32&&!n.match(/^[0-9a-f]{64}$/)?s("ERROR","Invalid room name."):document.location.hash="#"+n,j.addEventListener("keydown",e=>{38==e.keyCode?i.scrollBy(0,-50):40==e.keyCode?i.scrollBy(0,50):33==e.keyCode?i.scrollBy(0,-i.clientHeight+50):34==e.keyCode&&i.scrollBy(0,i.clientHeight-50)}),h.addEventListener("submit",e=>{e.preventDefault(),a&&a.send(JSON.stringify({message:j.value})),j.value="",i.scrollBy(0,1e8)}),j.addEventListener("input",e=>{e.currentTarget.value=e.currentTarget.value.slice(0,256)}),i.addEventListener("scroll",()=>{l=i.scrollTop+i.clientHeight>=i.scrollHeight}),j.focus(),document.body.addEventListener("click",()=>{window.getSelection().toString()==""&&j.focus()}),window.visualViewport&&window.visualViewport.addEventListener("resize",()=>{l&&i.scrollBy(0,1e8)}),t()}let u=0,v=!1;async function t(){const e="http:"===document.location.protocol?"ws://":"wss://",o=new WebSocket(e+window.location.host+"/api/room/"+n+"/websocket");let r=!1,s=Date.now();const w=async()=>{if(!r){r=!0,a=null;for(;k.firstChild;)k.removeChild(k.firstChild);let e=Date.now()-s;e<1e4&&await new Promise(t=>setTimeout(t,1e4-e)),t()}};o.addEventListener("open",()=>{a=o,a.send(JSON.stringify({name:m}))}),o.addEventListener("message",e=>{let t=JSON.parse(e.data);t.error?x(null,"* Error: "+t.error):t.joined?(p=document.createElement("p"),p.innerText=t.joined,k.appendChild(p)):t.quit&&[...k.childNodes].forEach(e=>{e.innerText==t.quit&&k.removeChild(e)}),t.ready&&!v&&(v=!0,x(null,"* This is a demo app built with Cloudflare Workers Durable Objects. The source code can be found at: https://github.com/cloudflare/workers-chat-demo"),x(null,"* WARNING: Participants in this chat are random people on the internet. Names are not authenticated; anyone can pretend to be anyone. The people you are chatting with are NOT Cloudflare employees. Chat history is saved."),n.length==64?x(null,"* This is a private room. You can invite someone to the room by sending them the URL."):x(null,"* Welcome to #"+n+". Say hi!")),t.timestamp>u&&(x(t.name,t.message),u=t.timestamp)}),o.addEventListener("close",e=>{console.log("WebSocket closed, reconnecting:",e.code,e.reason),w()}),o.addEventListener("error",e=>{console.log("WebSocket error, reconnecting:",e),w()})}function x(e,t){let n=document.createElement("p");e&&(r=document.createElement("span"),r.className="username",r.innerText=e+": ",n.appendChild(r)),n.appendChild(document.createTextNode(t)),i.appendChild(n),l&&i.scrollBy(0,1e8)}p();
</script></body></html>
